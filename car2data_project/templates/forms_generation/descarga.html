{% extends 'base.html' %}
{% block title %}Documento Generado{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header de éxito -->
    <div class="mb-8 text-center">
        <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 mb-4">
            <svg class="h-8 w-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
        </div>
        <h1 class="text-3xl font-bold text-dark-blue mb-2">¡Documento Generado Exitosamente!</h1>
        <p class="text-gray-600">
            Tu {{ generated_form.get_form_type_display|lower }} ha sido generado y autodiligenciado con los datos extraídos
        </p>
    </div>

    <!-- Información del documento -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-8">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-xl font-bold text-dark-blue">{{ generated_form.get_form_type_display }}</h2>
                <p class="text-gray-600">Basado en: {{ generated_form.document.name }}</p>
            </div>
            <div class="text-right">
                <span class="text-sm text-gray-500">Generado el</span>
                <p class="font-medium text-dark-blue">{{ generated_form.created_at|date:"d/m/Y H:i" }}</p>
            </div>
        </div>

        <!-- Vista previa del contenido -->
        <div class="border-2 border-dashed border-gray-200 rounded-lg p-8 mb-6">
            <div class="text-center">
                <svg class="mx-auto h-16 w-16 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <h3 class="text-lg font-medium text-gray-900 mb-2">Documento PDF Generado</h3>
                <p class="text-gray-600 mb-4">
                    El documento ha sido autodiligenciado con todos los datos extraídos de tu tarjeta de propiedad
                </p>
                
                <!-- Estadísticas del autodiligenciado -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mt-6">
                    <div class="bg-turquoise bg-opacity-10 rounded-lg p-4">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-turquoise">✓</div>
                            <div class="text-sm font-medium text-dark-blue mt-1">Datos del Vehículo</div>
                            <div class="text-xs text-gray-600">Autodiligenciados</div>
                        </div>
                    </div>
                    <div class="bg-orange bg-opacity-10 rounded-lg p-4">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-orange">✓</div>
                            <div class="text-sm font-medium text-dark-blue mt-1">Datos del Propietario</div>
                            <div class="text-xs text-gray-600">Autodiligenciados</div>
                        </div>
                    </div>
                    <div class="bg-green-100 rounded-lg p-4">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-600">✓</div>
                            <div class="text-sm font-medium text-dark-blue mt-1">Formato Oficial</div>
                            <div class="text-xs text-gray-600">Listo para usar</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Botones de acción -->
        <div class="flex flex-col sm:flex-row justify-center space-y-3 sm:space-y-0 sm:space-x-4">
            {% if download_url %}
            <!-- Botón de descarga principal -->
            <a href="{% url 'forms_generation:download_pdf' generated_form.id %}" 
               class="inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-lg text-white bg-gradient-to-r from-dark-blue to-turquoise hover:from-dark-blue hover:to-turquoise focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-turquoise transform transition duration-200 hover:scale-105 shadow-lg hover:shadow-xl">
                <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                Descargar Documento PDF
            </a>

            <!-- Vista previa en nueva pestaña -->
            <a href="{{ download_url }}" target="_blank"
               class="inline-flex items-center justify-center px-6 py-3 border border-gray-300 text-base font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-turquoise transition duration-200">
                <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                </svg>
                Vista Previa
            </a>

            <!-- Volver a editar datos (regresa a generate_form preservando campos) -->
            <button type="button" onclick="window.history.back()"
               class="inline-flex items-center justify-center px-6 py-3 border border-gray-300 text-base font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-turquoise transition duration-200">
                <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                Volver a editar datos
            </button>
            {% else %}
            <div class="text-center text-gray-500">
                <p>Error: No se pudo generar el archivo PDF</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Información adicional -->
    <div class="bg-blue-50 rounded-lg p-6 mb-8">
        <div class="flex">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                </svg>
            </div>
            <div class="ml-3">
                <h3 class="text-sm font-medium text-blue-800">Información importante</h3>
                <div class="mt-2 text-sm text-blue-700">
                    <ul class="list-disc pl-5 space-y-1">
                        <li>Revisa cuidadosamente toda la información antes de usar el documento oficialmente</li>
                        <li>Verifica que todos los datos autodiligenciados sean correctos</li>
                        <li>Este documento tiene validez legal cuando sea firmado por las partes correspondientes</li>
                        <li>Guarda una copia digital y física del documento</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Acciones adicionales -->
    <div class="text-center space-y-4">
        <div class="flex flex-col sm:flex-row justify-center space-y-3 sm:space-y-0 sm:space-x-4">
            <!-- Generar otro documento -->
            <a href="{% url 'forms_generation:forms' %}?document_id={{ generated_form.document.id }}"
               class="inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-semibold rounded-lg text-white bg-gradient-to-r from-dark-blue to-turquoise hover:from-dark-blue hover:to-turquoise transform transition duration-200 hover:scale-105 shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-turquoise">
                <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
                Generar Otro Documento
            </a>

            <!-- Ver historial -->
            <a href="{% url 'forms_generation:history' %}"
               class="inline-flex items-center justify-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-turquoise transition duration-200">
                <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Ver Historial
            </a>

            <!-- Volver al dashboard -->
            <a href="{% url 'documents:dashboard' %}"
               class="inline-flex items-center justify-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-turquoise transition duration-200">
                <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
                </svg>
                Dashboard
            </a>
        </div>

        <!-- Compartir o enviar -->
        <div class="pt-6 border-t">
            <p class="text-sm text-gray-500 mb-3">¿Necesitas compartir este documento?</p>
            <div class="flex justify-center space-x-3">
                <button onclick="copyDownloadLink()" 
                        class="inline-flex items-center px-3 py-1 border border-gray-300 rounded-md text-xs font-medium text-gray-700 bg-white hover:bg-gray-50">
                    <svg class="h-3 w-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                    </svg>
                    Copiar Enlace
                </button>
                
                <button onclick="printDocument()" 
                        class="inline-flex items-center px-3 py-1 border border-gray-300 rounded-md text-xs font-medium text-gray-700 bg-white hover:bg-gray-50">
                    <svg class="h-3 w-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
                    </svg>
                    Imprimir
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function copyDownloadLink() {
    const downloadUrl = window.location.origin + "{% if download_url %}{{ download_url }}{% endif %}";
    
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(downloadUrl).then(function() {
            showNotification('Enlace copiado al portapapeles', 'success');
        }, function() {
            fallbackCopyTextToClipboard(downloadUrl);
        });
    } else {
        fallbackCopyTextToClipboard(downloadUrl);
    }
}

function fallbackCopyTextToClipboard(text) {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    textArea.style.top = "0";
    textArea.style.left = "0";
    textArea.style.position = "fixed";

    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();

    try {
        const successful = document.execCommand('copy');
        const msg = successful ? 'Enlace copiado al portapapeles' : 'Error al copiar enlace';
        showNotification(msg, successful ? 'success' : 'error');
    } catch (err) {
        showNotification('Error al copiar enlace', 'error');
    }

    document.body.removeChild(textArea);
}

function printDocument() {
    /* {% if download_url %}
    window.open('{{ download_url }}', '_blank');
    {% endif %} */
}

function showNotification(message, type = 'info') {
    // Crear notificación temporal
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 px-4 py-3 rounded-lg shadow-lg z-50 transition-all duration-300 ${
        type === 'success' ? 'bg-green-500 text-white' : 
        type === 'error' ? 'bg-red-500 text-white' : 
        'bg-blue-500 text-white'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Animar entrada
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
        notification.style.opacity = '1';
    }, 100);
    
    // Remover después de 3 segundos
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        notification.style.opacity = '0';
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 300);
    }, 3000);
}

// Auto-descargar si es la primera visita (opcional)
document.addEventListener('DOMContentLoaded', function() {
    // Verificar si ya se descargó automáticamente
    const hasAutoDownloaded = sessionStorage.getItem('auto_downloaded_{{ generated_form.id }}');
    
    if (!hasAutoDownloaded) {
        // Marcar como descargado automáticamente
        sessionStorage.setItem('auto_downloaded_{{ generated_form.id }}', 'true');
        
        // Mostrar notificación indicando que el documento está listo
        showNotification('Documento generado listo para descarga', 'info');
    }
});
</script>
{% endblock %}